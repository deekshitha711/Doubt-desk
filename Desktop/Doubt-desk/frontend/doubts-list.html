<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Doubts - Doubt Desk</title>
  <style>
    /* YOUR ORIGINAL BEAUTIFUL CSS - 100% PRESERVED + ENHANCED */
    * { box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { 
      text-align: center; 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.8em; 
      margin-bottom: 2rem; 
      font-weight: 800;
    }
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 1.5rem; 
      justify-content: center; 
      margin-bottom: 2.5rem; 
    }
    .stat-card { 
      background: rgba(255,255,255,0.9); 
      backdrop-filter: blur(15px); 
      padding: 1.8rem; 
      border-radius: 20px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
      text-align: center; 
      border: 1px solid rgba(255,255,255,0.3); 
      transition: transform 0.3s ease;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-num { 
      font-size: 2.8rem; 
      font-weight: 900; 
      background: linear-gradient(45deg, #4CAF50, #8BC34A); 
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: block; 
    }
    .stat-label { 
      color: #666; 
      font-size: 1rem; 
      font-weight: 600; 
      text-transform: uppercase; 
      letter-spacing: 1px;
    }
    .tabs { 
      display: flex; 
      gap: 1rem; 
      margin-bottom: 2rem; 
      background: rgba(255,255,255,0.9); 
      padding: 1rem; 
      border-radius: 20px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      justify-content: center; 
      flex-wrap: wrap;
    }
    .tab-btn { 
      padding: 0.8rem 1.8rem; 
      border: none; 
      background: rgba(102,126,234,0.1); 
      border-radius: 25px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s; 
      color: #667eea; 
      border: 2px solid rgba(102,126,234,0.2);
    }
    .tab-btn.active { 
      background: linear-gradient(45deg, #667eea, #764ba2); 
      color: white; 
      transform: translateY(-2px);
    }
    .doubts-grid { display: grid; gap: 1.5rem; }
    .doubt-card { 
      background: rgba(255,255,255,0.95); 
      border-radius: 20px; 
      box-shadow: 0 15px 40px rgba(0,0,0,0.1); 
      overflow: hidden; 
      transition: all 0.4s ease; 
      cursor: pointer; 
      border: 1px solid rgba(255,255,255,0.3); 
      backdrop-filter: blur(10px);
    }
    .doubt-card:hover { 
      transform: translateY(-8px) scale(1.02); 
      box-shadow: 0 25px 60px rgba(0,0,0,0.2); 
    }
    .doubt-card.own { border-left: 6px solid #4CAF50; }
    .doubt-card.peer { border-left: 6px solid #FF9800; opacity: 0.9; }
    .doubt-header { 
      padding: 2rem 2.2rem; 
      border-bottom: 3px solid rgba(102,126,234,0.2); 
      background: linear-gradient(135deg, rgba(102,126,234,0.05), rgba(118,75,162,0.05));
    }
    .subject-badge { 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      color: white; 
      padding: 0.6rem 1.4rem; 
      border-radius: 25px; 
      font-weight: bold; 
      font-size: 0.9rem; 
      display: inline-block; 
      margin-bottom: 1rem; 
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }
    .doubt-title { 
      font-size: 1.6rem; 
      color: #333; 
      margin: 0 0 0.8rem; 
      font-weight: 700; 
      line-height: 1.4;
    }
    .doubt-meta { 
      color: #888; 
      font-size: 1rem; 
      display: flex; 
      gap: 1.5rem; 
      align-items: center;
    }
    .status-badge { 
      padding: 0.4rem 1rem; 
      border-radius: 20px; 
      font-size: 0.85rem; 
      font-weight: 600;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-answered { background: #d4edda; color: #155724; }
    .doubt-preview { 
      padding: 1.8rem 2.2rem; 
      color: #555; 
      line-height: 1.7; 
      max-height: 120px; 
      overflow: hidden;
    }
    .loading, .empty { 
      text-align: center; 
      padding: 6rem 2rem; 
      color: #666; 
      background: rgba(255,255,255,0.5); 
      border-radius: 20px; 
      backdrop-filter: blur(10px);
    }
    .back { 
      display: inline-block; 
      margin: 2rem auto; 
      color: #667eea; 
      text-decoration: none; 
      font-weight: 700; 
      padding: 1rem 2.5rem; 
      border: 2px solid #667eea; 
      border-radius: 30px; 
      font-size: 1.1rem; 
      transition: all 0.3s ease; 
      background: rgba(102,126,234,0.1);
    }
    .back:hover { 
      background: #667eea; 
      color: white; 
      transform: translateY(-2px);
    }
    .refresh-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(102,126,234,0.9);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      z-index: 1000;
      backdrop-filter: blur(15px);
    }
    @media (max-width: 768px) { 
      .stats { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
      .doubt-meta { flex-direction: column; gap: 0.5rem; }
      .refresh-btn { position: static; margin: 1rem auto; display: block; }
    }
  </style>
</head>
<body>
  <button class="refresh-btn" onclick="forceRefresh()">üîÑ Live Refresh</button>
  
  <div class="container">
    <h1>üìã My Doubts & Answers</h1>
    
    <!-- LIVE STATS - Anonymous -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-num" id="totalVisible">0</div>
        <div class="stat-label">Total Visible</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="myPending">0</div>
        <div class="stat-label">My Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="myAnswered">0</div>
        <div class="stat-label">My Answered</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="peerAnswered">0</div>
        <div class="stat-label">Peer Answers</div>
      </div>
    </div>

    <!-- TABS: All / My / Peer -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="all">All Doubts</button>
      <button class="tab-btn" data-tab="my">My Doubts</button>
      <button class="tab-btn" data-tab="peer">Subject Answers</button>
    </div>

    <div id="loading" class="loading" style="display: block;">
      <div style="font-size: 1.5rem; margin-bottom: 1rem;">üîÑ Loading your doubts...</div>
      <div>(Live sync with faculty answers)</div>
    </div>
    <div id="doubtsList" class="doubts-grid" style="display: none;"></div>
    <div id="emptyState" class="empty" style="display: none;">
      <div style="font-size: 5rem; margin-bottom: 1.5rem;">üì≠</div>
      <h3>No doubts yet!</h3>
      <p>Ask your first anonymous doubt.</p>
      <a href="ask-doubt.html" class="back" style="margin-top: 2rem;">Ask Doubt ‚Üí</a>
    </div>

    <a href="student-dashboard.html" class="back">‚Üê Dashboard</a>
  </div>

  <script>
    let currentTab = 'all';
    let allDoubts = [];
    let user = {};

    function loadDoubtsList() {
      try {
        user = JSON.parse(localStorage.getItem('studentData') || '{}');
        allDoubts = JSON.parse(localStorage.getItem('allDoubts') || '[]');

        const myDoubts = allDoubts.filter(d => d.studentId === user.studentId);
        const peerAnswered = allDoubts.filter(d => 
          d.subjects?.includes(user.subject) && // Match current subject
          d.status === 'resolved' && 
          d.studentId !== user.studentId
        );

        // LIVE ANONYMOUS STATS
        document.getElementById('totalVisible').textContent = myDoubts.length + peerAnswered.length;
        document.getElementById('myPending').textContent = myDoubts.filter(d => d.status === 'pending').length;
        document.getElementById('myAnswered').textContent = myDoubts.filter(d => d.status === 'resolved').length;
        document.getElementById('peerAnswered').textContent = peerAnswered.length;

        displayDoubts(currentTab);
        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        console.error('Load error:', error);
      }
    }

    function formatDate(ts) {
      if (!ts) return 'Just now';
      const date = new Date(ts);
      return date.toLocaleDateString(undefined, {
        year: 'numeric', month: 'short', day: 'numeric'
      });
    }

    function displayDoubts(tab) {
      const container = document.getElementById('doubtsList');
      const empty = document.getElementById('emptyState');
      
      let filteredDoubts = [];
      
      if (tab === 'my') {
        filteredDoubts = allDoubts.filter(d => d.studentId === user.studentId);
      } else if (tab === 'peer') {
        filteredDoubts = allDoubts.filter(d => 
          d.subject === user.subject && 
          d.status === 'resolved' && 
          d.studentId !== user.studentId
        );
      } else {
        // All: My doubts + peer resolved in same subject
        const myDoubts = allDoubts.filter(d => d.studentId === user.studentId);
        const peerResolved = allDoubts.filter(d => 
          d.subject === user.subject && 
          d.status === 'resolved' && 
          d.studentId !== user.studentId
        );
        filteredDoubts = [...myDoubts, ...peerResolved];
      }
      
      if (filteredDoubts.length === 0) {
        empty.style.display = 'block';
        container.style.display = 'none';
        return;
      }
      
      empty.style.display = 'none';
      container.style.display = 'grid';
      
      // Sort newest first
      filteredDoubts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      // **ANONYMOUS DISPLAY**
      container.innerHTML = filteredDoubts.map(doubt => {
        const isOwn = doubt.studentId === user.studentId;
        const statusClass = doubt.status === 'resolved' ? 'status-answered' : 'status-pending';
        const statusText = doubt.status === 'resolved' ? '‚úÖ Answered by Faculty' : '‚è≥ Awaiting Answer';
        return `
          <div class="doubt-card ${isOwn ? 'own' : 'peer'}" onclick="viewDoubt('${doubt.id}')">
            <div class="doubt-header">
              <div class="subject-badge">${doubt.subject} ‚Ä¢ ${doubt.sem || 'Sem 3'}</div>
              <h3 class="doubt-title">${doubt.title}</h3>
              <div class="doubt-meta">
                <span>üë§ Anonymous Student ${isOwn ? '(You)' : '(Peer)'}</span>
                <span class="status-badge ${statusClass}">${statusText}</span>
                <span>üïí ${formatDate(doubt.timestamp)}</span>
              </div>
            </div>
            <div class="doubt-preview">
              ${doubt.description.substring(0, 200)}${doubt.description.length > 200 ? '...' : ''}
              ${doubt.answer ? `<div style="margin-top:1rem;padding:1rem;background:#e8f5e8;border-left:4px solid #4CAF50;"><strong>Faculty Answer:</strong><br>${doubt.answer.substring(0,150)}...</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function showTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.tab-btn[data-tab="${tab}"]`)?.classList.add('active');
      displayDoubts(tab);
    }

    function viewDoubt(doubtId) {
      window.location.href = `doubt-detail.html?id=${doubtId}`;
    }

    function forceRefresh() {
      // ULTRA LIVE SYNC - Triggers all tabs instantly
      window.dispatchEvent(new Event('storage'));
      loadDoubtsList();
    }

    // Event listeners + auto-init
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          showTab(btn.dataset.tab);
        });
      });
      loadDoubtsList();
    });

    // üî• LIVE SYNC EVERY 2s + Storage + Focus
    setInterval(forceRefresh, 2000);
    window.addEventListener('storage', forceRefresh);
    window.addEventListener('focus', forceRefresh);
  </script>
</body>
</html>
