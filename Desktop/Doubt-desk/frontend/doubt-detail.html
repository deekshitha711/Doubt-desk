<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doubt Detail - Doubt Desk</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #f1f3f4 0%, #e0e5ec 100%); }
    .container { max-width: 900px; margin: 0 auto; }
    .doubt-header { background: white; border-radius: 20px 20px 0 0; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 0; }
    .subject-badge { background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white; padding: 10px 20px; border-radius: 30px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
    .doubt-title { font-size: 2.2em; color: #333; margin: 0 0 15px; }
    .doubt-meta { color: #888; font-size: 1em; margin-bottom: 20px; }
    .doubt-description { color: #555; line-height: 1.7; font-size: 1.1em; }
    .answers-section { background: white; border-radius: 0 0 20px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; margin-top: 0; }
    .answers-title { font-size: 1.8em; color: #333; margin-bottom: 25px; border-bottom: 3px solid #e9ecef; padding-bottom: 15px; }
    .answer-card { background: #f8f9fa; border-left: 5px solid #4CAF50; padding: 25px; margin-bottom: 20px; border-radius: 10px; }
    .answer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .answer-author { font-weight: bold; color: #333; }
    .answer-time { color: #888; font-size: 0.9em; }
    .answer-text { line-height: 1.6; color: #555; }
    .upvote-btn { background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9em; transition: all 0.3s; }
    .upvote-btn:hover { background: #1976d2; transform: scale(1.05); }
    .answer-form { background: #f8f9fa; padding: 30px; border-radius: 15px; margin-top: 30px; border: 2px dashed #dee2e6; }
    textarea { width: 100%; padding: 15px; border: 2px solid #dee2e6; border-radius: 10px; font-family: inherit; font-size: 16px; resize: vertical; min-height: 120px; margin-bottom: 15px; }
    .form-actions { display: flex; gap: 15px; flex-wrap: wrap; }
    .post-answer { flex: 1; background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; padding: 15px 25px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s; min-width: 150px; }
    .post-answer:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76,175,80,0.3); }
    .post-answer:disabled { background: #ccc; cursor: not-allowed; }
    .cancel { background: #6c757d; color: white; border: none; padding: 15px 25px; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
    .loading { text-align: center; padding: 50px; color: #666; font-style: italic; }
    .back { display: inline-block; margin: 20px 0; color: #2196F3; text-decoration: none; font-weight: bold; padding: 12px 25px; border: 2px solid #2196F3; border-radius: 25px; }
    @media (max-width: 768px) { .form-actions { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading" style="display:block;">üîÑ Loading doubt details...</div>
    <div id="error" style="display:none; background:#f8d7da;color:#721c24;padding:20px;border-radius:10px;text-align:center;"></div>

    <!-- Doubt Header -->
    <div id="doubtHeader" class="doubt-header" style="display:none;">
      <div class="subject-badge" id="subjectBadge"></div>
      <h1 class="doubt-title" id="doubtTitle"></h1>
      <div class="doubt-meta" id="doubtMeta"></div>
      <p class="doubt-description" id="doubtDescription"></p>
    </div>

    <!-- Answers Section -->
    <div id="answersSection" class="answers-section" style="display:none;">
      <h2 class="answers-title">
        üí¨ Answers (<span id="answersCount">0</span>)
      </h2>
      <div id="answersList"></div>

      <!-- Post Answer Form -->
      <div class="answer-form">
        <h3>üìù Add Your Answer</h3>
        <form id="answerForm">
          <textarea id="answerText" placeholder="Share your solution or thoughts... (Students/Faculty welcome)" required maxlength="1000"></textarea>
          <div class="form-actions">
            <button type="submit" class="post-answer" id="postBtn">Post Answer</button>
            <button type="button" class="cancel" onclick="clearForm()">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <a href="doubts-list.html" class="back">‚Üê Back to Doubts List</a>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const doubtId = urlParams.get('id');
    if (!doubtId) {
      document.getElementById('error').innerHTML = 'No doubt ID found. <a href="doubts-list.html">Go back</a>';
      document.getElementById('error').style.display = 'block';
      document.getElementById('loading').style.display = 'none';
    }

    async function loadDoubtDetail() {
      try {
        document.getElementById('loading').style.display = 'block';

        // TODO: Load full doubt via GET /api/doubts/:id (add backend endpoint)
        // For now, load answers only
        const res = await fetch(`https://doubt-desk-backendd.onrender.com/api/answers/${doubtId}`);
        if (!res.ok) throw new Error('Doubt not found');

        const answers = await res.json();
        console.log('Answers:', answers);

        document.getElementById('answersCount').textContent = answers.length;

        const answersList = document.getElementById('answersList');
        if (answers.length === 0) {
          answersList.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No answers yet. Be the first to help!</p>';
        } else {
          answersList.innerHTML = answers.map(answer => `
            <div class="answer-card">
              <div class="answer-header">
                <span class="answer-author">${answer.answeredBy} (${answer.role})</span>
                <span class="answer-time">${new Date(answer.createdAt).toLocaleString()}</span>
              </div>
              <div class="answer-text">${answer.answerText}</div>
              <div style="margin-top:15px;">
                <button class="upvote-btn" onclick="upvote(this)">üëç ${Math.floor(Math.random()*10)+1}</button>
              </div>
            </div>
          `).join('');
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('doubtHeader').style.display = 'block';
        document.getElementById('answersSection').style.display = 'block';

      } catch (err) {
        console.error(err);
        document.getElementById('error').textContent = `Error: ${err.message}. Backend retry?`;
        document.getElementById('error').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
      }
    }

    document.getElementById('answerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('answerText').value.trim();
      if (!text) return;

      const postBtn = document.getElementById('postBtn');
      postBtn.disabled = true;
      postBtn.textContent = 'Posting...';

      try {
        // TODO: Real Firebase UID + role from /api/users/:uid
        const userUid = 'student-' + Date.now();
        const formData = {
          doubtId,
          answerText: text,
          answeredBy: userUid,
          role: 'student' // or 'faculty'
        };

        const res = await fetch('https://doubt-desk-backendd.onrender.com/api/answers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (res.ok) {
          document.getElementById('answerText').value = '';
          loadDoubtDetail(); // Reload answers
        } else {
          throw new Error('Post failed');
        }
      } catch (err) {
        alert('Error posting: ' + err.message);
      } finally {
        postBtn.disabled = false;
        postBtn.textContent = 'Post Answer';
      }
    });

    function clearForm() {
      document.getElementById('answerText').value = '';
    }

    function upvote(btn) {
      let count = parseInt(btn.textContent.match(/\d+/)[0]) + 1;
      btn.textContent = `üëç ${count}`;
      btn.disabled = true;
    }

    // Load immediately
    loadDoubtDetail();
  </script>
</body>
</html>
